#!/usr/bin/env node

const got = require('got');
const fs = require('fs');
const chalk = require('chalk');

const url = process.env.URL;
const registry = process.env.REGISTRY || 'registry.npmjs.org';

if (!url) {
  console.log(`
${chalk.red('Please specify environment variable URL.')}
If you are Cloudflare employee:
  - open ${chalk.white.bold.underline('https://cflare.co/npm-login')} in browser (you only need the URL you are redirected to, not the content of the page)
  - run 'URL={copy URL you are redirected to} create-npmrc'`);
  process.exit(1);
}

console.log(`create-npmrc: Trying to fetch npm token from ${url}`);

got(url, { json: true })
  .then(response => {
    if (!response.body.ok || response.body.error) {
      console.error(error.body.error);
    } else {
      fs.writeFile('.npmrc', `//${registry}/:_authToken=${response.body.token}`, err => {
        if (err) {
          console.error(err);
        } else {
          console.log('.npmrc was successfully created!');
        }
      });
    }
  })
  .catch(error => {
    console.error('create-npmrc is not able to fetch the token');
  });
